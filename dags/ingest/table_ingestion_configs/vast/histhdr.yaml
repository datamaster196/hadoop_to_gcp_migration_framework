database_source: vast
dataset_name: vast
table_name: histhdr 
hwm_column: datestamp
split_by_column: datestamp
num_mappers: 3
target_dir: gs://adw-lake-vast-{ENV}/histhdr/source/{{{{ ds }}}}

query: >-
  select
    COMPANY,
    INVOICE_NUMBER,
    CUSTOMER_NUMBER,
    INVOICE_DATE,
    ESTIMATE_NUMBER,
    REASON_CODE,
    ADVERTISMENT,
    CATALOG_FLAG,
    DATESTAMP,
    LINE_NOS,
    CUSTOMER_TYPE,
    case
           when First_Name like '"'"'%%|||'"'"' then CONCAT(substring(First_Name, 1, len(First_Name)-3) , '"'"'3'"'"')
           when First_Name like '"'"'%%||'"'"' then CONCAT(substring(First_Name, 1, len(First_Name)-2) , '"'"'2'"'"')
           when First_Name like '"'"'%%|'"'"' then CONCAT(substring(First_Name, 1, len(First_Name)-1) , '"'"'1'"'"')
        else
               First_Name
        end
        as First_Name,
    LAST_NAME,
    ADDRESS,
    ADDRESS2,
    CITY,
    STATE,
    ZIPCODE,
    DAY_AREA_CODE,
    DAY_THREE,
    DAY_FOUR,
    DAY_EXTENSION,
    NIGHT_AREA_CODE,
    NIGHT_THREE,
    NIGHT_FOUR,
    NIGHT_EXTENSION,
    OTHER_AREA_CODE,
    OTHER_THREE,
    OTHER_FOUR,
    OTHER_EXTENSION,
    case
             when CONTACT_PERSON like '"'"'%%|||'"'"' then CONCAT(substring(CONTACT_PERSON, 1, len(CONTACT_PERSON)-3) , '"'"'3'"'"')
             when CONTACT_PERSON like '"'"'%%||'"'"' then CONCAT(substring(CONTACT_PERSON, 1, len(CONTACT_PERSON)-2) , '"'"'2'"'"')
             when CONTACT_PERSON like '"'"'%%|'"'"' then CONCAT(substring(CONTACT_PERSON, 1, len(CONTACT_PERSON)-1) , '"'"'1'"'"')
          else
                 CONTACT_PERSON
          end
          as CONTACT_PERSON,
    CUSTOMER_SORT_CODE,
    GENDER,
    BAL_METHOD,
    TAX_EXEMPT_NUMBER,
    DRIVERS_LIC_NUMBER,
    DRIVERS_LIC_STATE,
    CAR_YEAR,
    USA_FOR,
    MAKE,
    MODEL,
    ENGINE_TYPE,
    LIC_NUMBER,
    LIC_STATE,
    INSP_DATE,
    FLEET,
    MILEAGE_IN,
    MILEAGE_OUT,
    VIN_NUMBER,
    STATE_TAX_TOTAL,
    LOCAL_TAX_TOTAL,
    COUNTY_TAX_TOTAL,
    OTHER_TAX_TOTAL,
    DISCOUNT_TOTAL,
    TOTAL_SALE_AMOUNT,
    REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(MAX),INVOICE_COMMENTS), CHAR(10), CHAR(32)), CHAR(13), CHAR(32)), CHAR(124), CHAR(32)) as INVOICE_COMMENTS,
    INVOICE_COMMENTS2,
    INVOICE_COMMENTS3,
    SALESMAN_NUMBER,
    ESTIMATOR_NUMBER,
    CAR_NUMBER,
    STATUS,
    DECLINED,
    COMPARISON_TOTAL,
    P_O_NUMBER,
    DISCOUNT_PERCENTAGE,
    TOTAL_ROA_AMOUNT,
    TOTAL_BUYOUT_AMOUNT,
    TOTAL_DISCOUNTABLE_AMOUNT,
    SUBTRACT_JOB,
    OUTSIDE_PURCH_FLAG,
    TAXABLE,
    COMPLETION_DATE,
    REPLACE(REPLACE(REPLACE(CONVERT(VARCHAR(MAX),COMMENTS), CHAR(10), CHAR(32)), CHAR(13), CHAR(32)), CHAR(124), CHAR(32)) as COMMENTS,
    MANAGER_NUMBER,
    ROA_FLAG,
    TOTAL_COLLECTED,
    CHANGE,
    WAITING_STATUS,
    DEPOSIT_IND,
    REWORK_IND,
    REWORK_INVOICE,
    PAYOUT_ESTIMATE,
    EMAILADDRESS,
    PHONE_QUOTE,
    CONV_PHONE_QUOTE,
    PAYOUT_REASON,
    GL_MAIN,
    GL_SUB,
    TOTAL_TAXABLE_AMOUNT,
    OLD_PARTS,
    AUTH_NAME,
    AUTH_AREA_CODE,
    AUTH_THREE,
    AUTH_FOUR,
    AUTH_EXTENSION,
    AUTH_AMOUNT,
    AUTH_DATE,
    AUTH_TIME,
    AUTH_EMPLOYEE,
    OVER_THE_COUNTER,
    THIRD_PARTY,
    PARTS_REQUESTED,
    REPRINT_COUNT,
    ALLIANCE_CARID,
    QUICK_QUOTE,
    APPOINTMENT,
    PRINT_DATE,
    ALLIANCE_PHOTO,
    REASON_LIST,
    BRINGUP_DATE,
    PAYOUT_CODE,
    ESTIMATE_TIME,
    PRIOR_RECORD,
    DISPOSAL_TYPE,
    YESCLUB_ID,
    CAR_COLOR,
    MANAGER_COLLECTION_REPORT_NUMB,
    PRINT_COMMENTS,
    TAX_EXEMPT_REASCODE,
    FUTURE_SERVICES,
    NEEDED_SERVICES,
    SEND_THANK_YOU,
    CHAIN,
    FLEETPROXYNUMBER,
    FLEETPROXYNAME,
    FREEZE_FEE,
    ORIG_INVOICE_NUMBER,
    CREDIT_AUTHORIZATION,
    VOIDED,
    ORIG_INVOICE_DATE,
    VOID_REASON,
    DISC_AMOUNT,
    CAN_PST,
    CAN_GST,
    HIST_PO_NO,
    HIST_PO_DATE,
    PROCESSED,
    INSPECT_MONTH,
    FORCE_NONHOUSE_PAYMENT,
    BATCH_PROCESSED,
    [USE],
    KILOMETERS,
    NEEDS_BY_DATE,
    NEEDS_BY_TIME,
    DIAG_BY_DATE,
    DIAG_BY_TIME,
    COMPLETION_OPTION,
    DELIVERY_SAME,
    MARK_AS_REFUND,
    FRANCHISE_CONTROL_NBR,
    FRANCHISE_CONTROL_NBR2,
    DELIVERY_TO_ADDRESS1,
    DELIVERY_TO_ADDRESS2,
    DELIVERY_TO_CITY,
    DELIVERY_TO_STATE,
    DELIVERY_TO_ZIP,
    MACDONALD_CARID,
    CPT_CARID,
    Key_Tag,
    PRICING_LOCKED,
    NEW_CUST_FLAG,
    ARTERM_CODE,
    INSTALMNT_NBR,
    INSTALMNT_DUE_DATE_1,
    LEVEL1TAX_TOTAL,
    LEVEL2TAX_TOTAL,
    LEVEL3TAX_TOTAL,
    LEVEL4TAX_TOTAL,
    LEVEL5TAX_TOTAL,
    LEVEL6TAX_TOTAL,
    LEVEL7TAX_TOTAL,
    LEVEL8TAX_TOTAL,
    LEVEL9TAX_TOTAL,
    ISLEVEL1TAXABLE,
    ISLEVEL2TAXABLE,
    ISLEVEL3TAXABLE,
    ISLEVEL4TAXABLE,
    ISLEVEL5TAXABLE,
    ISLEVEL6TAXABLE,
    ISLEVEL7TAXABLE,
    ISLEVEL8TAXABLE,
    ISLEVEL9TAXABLE,
    LEVEL1TAX_EXEMPT_NUMBER,
    LEVEL2TAX_EXEMPT_NUMBER,
    LEVEL3TAX_EXEMPT_NUMBER,
    LEVEL4TAX_EXEMPT_NUMBER,
    LEVEL5TAX_EXEMPT_NUMBER,
    LEVEL6TAX_EXEMPT_NUMBER,
    LEVEL7TAX_EXEMPT_NUMBER,
    LEVEL8TAX_EXEMPT_NUMBER,
    LEVEL9TAX_EXEMPT_NUMBER,
    COUNTRY,
    LOCAL_TAX_EXEMPT,
    NET_DUE_DATE,
    ORIG_ADJ_INV_NUMBER,
    UNIT_NUMBER,
    AUDIT_TRAIL_USER_ID,
    ADPCashierID,
    ADPSHTransmitted,
    ADPFSTransmitted,
    ADPFPTransmitted,
    ADPACTransmitted,
    NOT_TO_GOODYEAR,
    GOODYEAR_INV_NO,
    GY_DOC_TYPE,
    GY_EXEMPT_IND,
    Goodyear_Claim_Number,
    Claim_type,
    ORIG_DR_NO,
    Tax_Certificate,
    REF_Doc_ID,
    REF_Order_Type,
    UNIQUE_ID,
    DISALLOW_TAGALONGS,
    Out_of_city,
    Out_of_county,
    GEOCODE,
    four_tires_now_number,
    roll_date,
    TYPEH_FOUR_TIRES_NOW,
    BUYING_LEVEL,
    SPECIALPGMS,
    SoftwareID,
    Eod_Status,
    Eod_DateStamp,
    TaxID,
    TaxType,
    IS_IT_FLEETTEAM,
    Freight,
    FreightCost,
    FreightTax,
    FreightTaxable,
    TOTALFET,
    ShipToID,
    EOD_SENT_XPLOR,
    INTEGRATED_TO_3RD_PARTY,
    TIRE_INFLATION,
    LUG_TORQUE,
    DUAL_REAR,
    Car_Type,
    Taxability_Changed_At_POS,
    VEW_WasOWPrinted,
    WMS_PickingRequestOK,
    Member_ID_Number,
    Member_ID_ExpDate,
    BASE_VEHICLE_ID,
    ENGINE_BASE_ID,
    WISE_IsAllocated,
    WISE_FileSent,
    CURRENT_TIMESTAMP as adw_lake_insert_datetime,
    {{{{ dag_run.id }}}} as adw_lake_insert_batch_number
   from  [{db_name}].dbo.histhdr
  where $CONDITIONS


ddl: >-
  CREATE TABLE IF NOT EXISTS `{INGESTION_PROJECT}.vast.histhdr`
    (   COMPANY                      String,
      	INVOICE_NUMBER               String,
      	CUSTOMER_NUMBER              String,
      	INVOICE_DATE                 String,
      	ESTIMATE_NUMBER              String,
      	REASON_CODE                  String,
      	ADVERTISMENT                 String,
      	CATALOG_FLAG                 String,
      	DATESTAMP                    String,
      	LINE_NOS                     String,
      	CUSTOMER_TYPE                String,
      	FIRST_NAME                   String,
      	LAST_NAME                    String,
      	ADDRESS                      String,
      	ADDRESS2                     String,
      	CITY                         String,
      	STATE                        String,
      	ZIPCODE                      String,
      	DAY_AREA_CODE                String,
      	DAY_THREE                    String,
      	DAY_FOUR                     String,
      	DAY_EXTENSION                String,
      	NIGHT_AREA_CODE              String,
      	NIGHT_THREE                  String,
      	NIGHT_FOUR                   String,
      	NIGHT_EXTENSION              String,
      	OTHER_AREA_CODE              String,
      	OTHER_THREE                  String,
      	OTHER_FOUR                   String,
      	OTHER_EXTENSION              String,
      	CONTACT_PERSON               String,
      	CUSTOMER_SORT_CODE           String,
      	GENDER                       String,
      	BAL_METHOD                   String,
      	TAX_EXEMPT_NUMBER            String,
      	DRIVERS_LIC_NUMBER           String,
      	DRIVERS_LIC_STATE            String,
      	CAR_YEAR                     String,
      	USA_FOR                      String,
      	MAKE                         String,
      	MODEL                        String,
      	ENGINE_TYPE                  String,
      	LIC_NUMBER                   String,
      	LIC_STATE                    String,
      	INSP_DATE                    String,
      	FLEET                        String,
      	MILEAGE_IN                   String,
      	MILEAGE_OUT                  String,
      	VIN_NUMBER                   String,
      	STATE_TAX_TOTAL              String,
      	LOCAL_TAX_TOTAL              String,
      	COUNTY_TAX_TOTAL             String,
      	OTHER_TAX_TOTAL              String,
      	DISCOUNT_TOTAL               String,
      	TOTAL_SALE_AMOUNT            String,
      	INVOICE_COMMENTS             String,
      	INVOICE_COMMENTS2            String,
      	INVOICE_COMMENTS3            String,
      	SALESMAN_NUMBER              String,
      	ESTIMATOR_NUMBER             String,
      	CAR_NUMBER                   String,
      	STATUS                       String,
      	DECLINED                     String,
      	COMPARISON_TOTAL             String,
      	P_O_NUMBER                   String,
      	DISCOUNT_PERCENTAGE          String,
      	TOTAL_ROA_AMOUNT             String,
      	TOTAL_BUYOUT_AMOUNT          String,
      	TOTAL_DISCOUNTABLE_AMOUNT    String,
      	SUBTRACT_JOB                 String,
      	OUTSIDE_PURCH_FLAG           String,
      	TAXABLE                      String,
      	COMPLETION_DATE              String,
      	COMMENTS                     String,
      	MANAGER_NUMBER               String,
      	ROA_FLAG                     String,
      	TOTAL_COLLECTED              String,
      	CHANGE                       String,
      	WAITING_STATUS               String,
      	DEPOSIT_IND                  String,
      	REWORK_IND                   String,
      	REWORK_INVOICE               String,
      	PAYOUT_ESTIMATE              String,
      	EMAILADDRESS                 String,
      	PHONE_QUOTE                  String,
      	CONV_PHONE_QUOTE             String,
      	PAYOUT_REASON                String,
      	GL_MAIN                      String,
      	GL_SUB                       String,
      	TOTAL_TAXABLE_AMOUNT         String,
      	OLD_PARTS                    String,
      	AUTH_NAME                    String,
      	AUTH_AREA_CODE               String,
      	AUTH_THREE                   String,
      	AUTH_FOUR                    String,
      	AUTH_EXTENSION               String,
      	AUTH_AMOUNT                  String,
      	AUTH_DATE                    String,
      	AUTH_TIME                    String,
      	AUTH_EMPLOYEE                String,
      	OVER_THE_COUNTER             String,
      	THIRD_PARTY                  String,
      	PARTS_REQUESTED              String,
      	REPRINT_COUNT                String,
      	ALLIANCE_CARID               String,
      	QUICK_QUOTE                  String,
      	APPOINTMENT                  String,
      	PRINT_DATE                   String,
      	ALLIANCE_PHOTO               String,
      	REASON_LIST                  String,
      	BRINGUP_DATE                 String,
      	PAYOUT_CODE                  String,
      	ESTIMATE_TIME                String,
      	PRIOR_RECORD                 String,
      	DISPOSAL_TYPE                String,
      	YESCLUB_ID                   String,
      	CAR_COLOR                    String,
      	MANAGER_COLLECTION_REPORT_NUMB String,
      	PRINT_COMMENTS               String,
      	TAX_EXEMPT_REASCODE          String,
      	FUTURE_SERVICES              String,
      	NEEDED_SERVICES              String,
      	SEND_THANK_YOU               String,
      	CHAIN                        String,
      	FLEETPROXYNUMBER             String,
      	FLEETPROXYNAME               String,
      	FREEZE_FEE                   String,
      	ORIG_INVOICE_NUMBER          String,
      	CREDIT_AUTHORIZATION         String,
      	VOIDED                       String,
      	ORIG_INVOICE_DATE            String,
      	VOID_REASON                  String,
      	DISC_AMOUNT                  String,
      	CAN_PST                      String,
      	CAN_GST                      String,
      	HIST_PO_NO                   String,
      	HIST_PO_DATE                 String,
      	PROCESSED                    String,
      	INSPECT_MONTH                String,
      	FORCE_NONHOUSE_PAYMENT       String,
      	BATCH_PROCESSED              String,
      	USE                          String,
      	KILOMETERS                   String,
      	NEEDS_BY_DATE                String,
      	NEEDS_BY_TIME                String,
      	DIAG_BY_DATE                 String,
      	DIAG_BY_TIME                 String,
      	COMPLETION_OPTION            String,
      	DELIVERY_SAME                String,
      	MARK_AS_REFUND               String,
      	FRANCHISE_CONTROL_NBR        String,
      	FRANCHISE_CONTROL_NBR2       String,
      	DELIVERY_TO_ADDRESS1         String,
      	DELIVERY_TO_ADDRESS2         String,
      	DELIVERY_TO_CITY             String,
      	DELIVERY_TO_STATE            String,
      	DELIVERY_TO_ZIP              String,
      	MACDONALD_CARID              String,
      	CPT_CARID                    String,
      	Key_Tag                      String,
      	PRICING_LOCKED               String,
      	NEW_CUST_FLAG                String,
      	ARTERM_CODE                  String,
      	INSTALMNT_NBR                String,
      	INSTALMNT_DUE_DATE_1         String,
      	LEVEL1TAX_TOTAL              String,
      	LEVEL2TAX_TOTAL              String,
      	LEVEL3TAX_TOTAL              String,
      	LEVEL4TAX_TOTAL              String,
      	LEVEL5TAX_TOTAL              String,
      	LEVEL6TAX_TOTAL              String,
      	LEVEL7TAX_TOTAL              String,
      	LEVEL8TAX_TOTAL              String,
      	LEVEL9TAX_TOTAL              String,
      	ISLEVEL1TAXABLE              String,
      	ISLEVEL2TAXABLE              String,
      	ISLEVEL3TAXABLE              String,
      	ISLEVEL4TAXABLE              String,
      	ISLEVEL5TAXABLE              String,
      	ISLEVEL6TAXABLE              String,
      	ISLEVEL7TAXABLE              String,
      	ISLEVEL8TAXABLE              String,
      	ISLEVEL9TAXABLE              String,
      	LEVEL1TAX_EXEMPT_NUMBER      String,
      	LEVEL2TAX_EXEMPT_NUMBER      String,
      	LEVEL3TAX_EXEMPT_NUMBER      String,
      	LEVEL4TAX_EXEMPT_NUMBER      String,
      	LEVEL5TAX_EXEMPT_NUMBER      String,
      	LEVEL6TAX_EXEMPT_NUMBER      String,
      	LEVEL7TAX_EXEMPT_NUMBER      String,
      	LEVEL8TAX_EXEMPT_NUMBER      String,
      	LEVEL9TAX_EXEMPT_NUMBER      String,
      	COUNTRY                      String,
      	LOCAL_TAX_EXEMPT             String,
      	NET_DUE_DATE                 String,
      	ORIG_ADJ_INV_NUMBER          String,
      	UNIT_NUMBER                  String,
      	AUDIT_TRAIL_USER_ID          String,
      	ADPCashierID                 String,
      	ADPSHTransmitted             String,
      	ADPFSTransmitted             String,
      	ADPFPTransmitted             String,
      	ADPACTransmitted             String,
      	NOT_TO_GOODYEAR              String,
      	GOODYEAR_INV_NO              String,
      	GY_DOC_TYPE                  String,
      	GY_EXEMPT_IND                String,
      	Goodyear_Claim_Number        String,
      	Claim_type                   String,
      	ORIG_DR_NO                   String,
      	Tax_Certificate              String,
      	REF_Doc_ID                   String,
      	REF_Order_Type               String,
      	UNIQUE_ID                    String,
      	DISALLOW_TAGALONGS           String,
      	Out_of_city                  String,
      	Out_of_county                String,
      	GEOCODE                      String,
      	four_tires_now_number        String,
      	roll_date                    String,
      	TYPEH_FOUR_TIRES_NOW         String,
      	BUYING_LEVEL                 String,
      	SPECIALPGMS                  String,
      	SoftwareID                   String,
      	Eod_Status                   String,
      	Eod_DateStamp                String,
      	TaxID                        String,
      	TaxType                      String,
      	IS_IT_FLEETTEAM              String,
      	Freight                      String,
      	FreightCost                  String,
      	FreightTax                   String,
      	FreightTaxable               String,
      	TOTALFET                     String,
      	ShipToID                     String,
      	EOD_SENT_XPLOR               String,
      	INTEGRATED_TO_3RD_PARTY      String,
      	TIRE_INFLATION               String,
      	LUG_TORQUE                   String,
      	DUAL_REAR                    String,
      	Car_Type                     String,
      	Taxability_Changed_At_POS    String,
      	VEW_WasOWPrinted             String,
      	WMS_PickingRequestOK         String,
      	Member_ID_Number             String,
      	Member_ID_ExpDate            String,
      	BASE_VEHICLE_ID              String,
      	ENGINE_BASE_ID               String,
      	WISE_IsAllocated             String,
      	WISE_FileSent                String,
      	adw_lake_insert_datetime     datetime,
      	adw_lake_insert_batch_number int64
      ) PARTITION BY DATE(_PARTITIONTIME);



